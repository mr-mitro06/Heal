<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoTrace - Daily Nature Tracker</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color, #ecfccb); /* Default: Lime-100 */
            overscroll-behavior-y: none;
            /* Game-like background pattern */
            background-image: radial-gradient(var(--pattern-color, #d9f99d) 2px, transparent 2px);
            background-size: 24px 24px;
            transition: background-color 0.8s cubic-bezier(0.4, 0, 0.2, 1), background-image 0.8s ease;
        }
        :root {
            --primary-color: #84cc16; /* lime-500 */
            --primary-dark: #65a30d; /* lime-600 */
            --secondary-color: #fef08a; /* yellow-200 */
        }
        .theme-forest { --bg-color: #ecfccb; --pattern-color: #d9f99d; }
        .theme-ocean { --bg-color: #e0f2fe; --pattern-color: #bae6fd; } /* sky-100, sky-200 */
        .theme-sunset { --bg-color: #ffedd5; --pattern-color: #fed7aa; } /* orange-100, orange-200 */
        .theme-rose { --bg-color: #ffe4e6; --pattern-color: #fecdd3; } /* rose-100, rose-200 */
        .theme-dark { --bg-color: #1e293b; --pattern-color: #334155; color: #f1f5f9; } /* slate-800, slate-700 */

        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Floating animation for avatars */
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        /* Breathing animation for "Alive" look */
        .animate-breathe {
            animation: breathe 4s ease-in-out infinite;
            transform-origin: bottom center;
        }
        @keyframes breathe {
            0%, 100% { transform: scaleY(1) scaleX(1); }
            50% { transform: scaleY(1.05) scaleX(0.98); }
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tap-highlight-transparent {
            -webkit-tap-highlight-color: transparent;
        }
        /* 3D Button Effect */
        .btn-game {
            transition: all 0.1s;
            border-bottom-width: 4px;
        }
        .btn-game:active {
            transform: translateY(2px);
            border-bottom-width: 0px;
            margin-bottom: 2px; /* Maintain layout */
        }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen overflow-hidden selection:bg-lime-200 transition-colors duration-500">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Inline Icons ---
        const Icon = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Leaf = (props) => <Icon {...props}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></Icon>;
        const Droplet = (props) => <Icon {...props}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></Icon>;
        const Wind = (props) => <Icon {...props}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></Icon>;
        const Zap = (props) => <Icon {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;
        const Smartphone = (props) => <Icon {...props}><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></Icon>;
        const Home = (props) => <Icon {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>;
        const ArrowRight = (props) => <Icon {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></Icon>;
        const Check = (props) => <Icon {...props}><polyline points="20 6 9 17 4 12"/></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></Icon>;
        const RefreshCw = (props) => <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>;
        const Trophy = (props) => <Icon {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></Icon>;
        const Flame = (props) => <Icon {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.243-2.143.5-3.5 1.072 2.143 1.5 3.5 3 4Z"/></Icon>;
        const Coins = (props) => <Icon {...props}><circle cx="12" cy="12" r="8"/><path d="M12 16V8"/><path d="M10 10h4"/></Icon>;
        const Gift = (props) => <Icon {...props}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></Icon>;
        const Lock = (props) => <Icon {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>;
        const Gamepad = (props) => <Icon {...props}><line x1="6" x2="10" y1="12" y2="12"/><line x1="8" x2="8" y1="10" y2="14"/><line x1="15" x2="15.01" y1="13" y2="13"/><line x1="18" x2="18.01" y1="11" y2="11"/><rect x="2" y="6" width="20" height="12" rx="2"/></Icon>;
        const LayoutDashboard = (props) => <Icon {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></Icon>;
        const Cloud = (props) => <Icon {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3c-1.7 0-3 1.3-3 3"/><path d="M17.5 19c3 0 5.5-2.5 5.5-5.5c0-2.7-2-5-4.6-5.4c-0.3-2.7-2.6-4.9-5.4-4.9c-2.3 0-4.3 1.5-5.1 3.6C4.7 7.2 2 9.7 2 12.8c0 3 2.5 5.5 5.5 5.5"/><path d="M12 10v9"/><path d="M8 14l4 4 4-4"/></Icon>; // Using as simpler cloud
        const Sprout = (props) => <Icon {...props}><path d="M7 20h10"/><path d="M10 20c5.5-2.5.8-6.4 3-10"/><path d="M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.5.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z"/><path d="M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.6 4.3-1.4 1-1 1.6-2.3 1.7-4.6-2.7.1-4 1-4.9 2z"/></Icon>;
        const Palette = (props) => <Icon {...props}><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></Icon>;
        const ShoppingCart = (props) => <Icon {...props}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></Icon>;
        const XCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></Icon>;

        // --- Data ---
        const avatars = [
            { id: 1, name: 'Leafy', seed: 'Felix', color: 'bg-green-100' },
            { id: 2, name: 'Daisy', seed: 'Willow', color: 'bg-rose-100' },
            { id: 3, name: 'Aqua', seed: 'Aneka', color: 'bg-blue-100' },
            { id: 4, name: 'Bella', seed: 'Bella', color: 'bg-purple-100' },
            { id: 5, name: 'Sunny', seed: 'Molly', color: 'bg-yellow-100' },
            { id: 6, name: 'Terra', seed: 'Oliver', color: 'bg-stone-100' },
            { id: 7, name: 'Bloom', seed: 'Sugar', color: 'bg-pink-100' },
            { id: 8, name: 'Rocky', seed: 'Boots', color: 'bg-gray-100' },
        ];

        const themes = [
            { id: 'forest', name: 'Forest', color: 'bg-lime-200', price: 0, locked: false },
            { id: 'ocean', name: 'Ocean', color: 'bg-sky-200', price: 500, locked: true }, // Price increased
            { id: 'sunset', name: 'Sunset', color: 'bg-orange-200', price: 1000, locked: true }, // Price increased
            { id: 'rose', name: 'Rose', color: 'bg-pink-200', price: 1500, locked: true }, // Price increased
            { id: 'dark', name: 'Midnight', color: 'bg-slate-700', price: 2500, locked: true }, // Price increased
        ];

        const ecoQuotes = [
            "The Earth is what we all have in common.",
            "Time spent among trees is never time wasted.",
            "He that plants trees loves others besides himself.",
            "There is no Planet B.",
            "Small acts, multiplied by millions, can transform the world.",
            "The greatest threat to our planet is the belief that someone else will save it.",
            "Nature does not hurry, yet everything is accomplished.",
            "Keep close to Nature's heart."
        ];

        const questions = [
            { id: 'bath', title: 'Morning Ritual', icon: <Droplet className="text-blue-500" />, text: 'How did you bathe today?', options: [
                { label: 'Quick Cold/Bucket', type: 'green', score: 20, feedback: 'Great! Low energy.' },
                { label: 'Short Warm Shower', type: 'yellow', score: 10, feedback: 'Moderate use.' },
                { label: 'Long Hot Shower', type: 'red', score: 0, feedback: 'High energy!' }
            ], science: { title: 'Thermodynamics', content: 'Heating water is the #1 energy consumer in a household.' } },
            { id: 'travel', title: 'The Commute', icon: <Wind className="text-teal-500" />, text: 'How did you travel?', options: [
                { label: 'Walk / Cycle', type: 'green', score: 20, feedback: 'Zero emissions!' },
                { label: 'Bus / Metro', type: 'yellow', score: 15, feedback: 'Shared fuel.' },
                { label: 'Car / Solo Bike', type: 'red', score: 0, feedback: 'High pollution.' }
            ], science: { title: 'Combustion Efficiency', content: 'Public transport moves 50x more people per engine than cars.' } },
            { id: 'food', title: 'Lunch Time', icon: <Trash2 className="text-orange-500" />, text: 'Lunch packaging?', options: [
                { label: 'Reusable Box', type: 'green', score: 20, feedback: 'Excellent.' },
                { label: 'Paper Box', type: 'yellow', score: 10, feedback: 'Better than plastic.' },
                { label: 'Single-use Plastic', type: 'red', score: 0, feedback: 'Landfill waste.' }
            ], science: { title: 'Degradation', content: 'Single-use plastics take 450 years to decompose.' } },
            { id: 'screen', title: 'Screen Time', icon: <Smartphone className="text-indigo-500" />, text: 'Streaming habits?', options: [
                { label: 'Wi-Fi / Downloaded', type: 'green', score: 20, feedback: 'Efficient.' },
                { label: '4G Streaming', type: 'yellow', score: 10, feedback: 'High energy.' },
                { label: '4K on Mobile Data', type: 'red', score: 0, feedback: 'Massive load.' }
            ], science: { title: 'Data Energy', content: 'Mobile data uses 4x more energy than Wi-Fi.' } },
            { id: 'sleep', title: 'Sleep Mode', icon: <Home className="text-purple-500" />, text: 'Sleep Setup?', options: [
                { label: 'Fan / Windows', type: 'green', score: 20, feedback: 'Natural cool.' },
                { label: 'AC 24¬∞C + Timer', type: 'yellow', score: 10, feedback: 'Optimized.' },
                { label: 'AC 18¬∞C All Night', type: 'red', score: 0, feedback: 'Power hungry.' }
            ], science: { title: 'Cooling Load', content: 'Every degree below 24¬∞C increases AC power use by 6%.' } },
        ];

        // --- Helper: Confetti ---
        const fireConfetti = () => {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#84cc16', '#22c55e', '#eab308']
            });
        };

        // --- GAME COMPONENTS ---

        const EnergySaverGame = ({ onComplete }) => {
            const [lights, setLights] = useState(Array(9).fill(false)); // true = ON (bad)
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(12); // Reduced time for difficulty
            const [gameOver, setGameOver] = useState(false);

            useEffect(() => {
                if (gameOver) return;
                const interval = setInterval(() => {
                    setLights(prev => {
                        const newLights = [...prev];
                        // Faster spawns
                        if (Math.random() > 0.4) {
                            const idx = Math.floor(Math.random() * 9);
                            newLights[idx] = true;
                        }
                        return newLights;
                    });
                }, 500); // Faster interval
                return () => clearInterval(interval);
            }, [gameOver]);

            useEffect(() => {
                if (timeLeft > 0 && !gameOver) {
                    const timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                    return () => clearInterval(timer);
                } else if (timeLeft === 0) {
                    setGameOver(true);
                }
            }, [timeLeft, gameOver]);

            const toggleLight = (idx) => {
                if (lights[idx] && !gameOver) {
                    const newLights = [...lights];
                    newLights[idx] = false;
                    setLights(newLights);
                    setScore(s => s + 5); // Reduced score
                }
            };

            return (
                <div className="flex flex-col items-center h-full">
                    <div className="flex justify-between w-full mb-4 px-2">
                        <span className="font-bold text-slate-600">Time: {timeLeft}s</span>
                        <span className="font-black text-lime-600">Score: {score}</span>
                    </div>
                    
                    {!gameOver ? (
                        <div className="grid grid-cols-3 gap-4 w-full max-w-[300px]">
                            {lights.map((isOn, i) => (
                                <button
                                    key={i}
                                    onClick={() => toggleLight(i)}
                                    className={`aspect-square rounded-2xl shadow-md transition-all duration-100 flex items-center justify-center text-4xl
                                        ${isOn ? 'bg-yellow-300 border-b-4 border-yellow-500 active:mt-1 active:border-b-0' : 'bg-slate-700 border-b-4 border-slate-900 opacity-50 cursor-default'}`}
                                >
                                    {isOn ? 'üí°' : ''}
                                </button>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center mt-10">
                            <h3 className="text-2xl font-black text-slate-800 mb-2">Game Over!</h3>
                            <p className="text-slate-600 mb-6">You saved {score / 5} lights.</p>
                            <button onClick={() => onComplete(score)} className="bg-lime-500 text-white px-8 py-3 rounded-xl font-black btn-game">Collect Tokens</button>
                        </div>
                    )}
                    <p className="mt-6 text-sm text-slate-500 text-center">Tap the yellow lights FAST!</p>
                </div>
            );
        };

        const TrashMasterGame = ({ onComplete }) => {
            const items = [
                { icon: 'üçé', type: 'compost' }, { icon: 'üçå', type: 'compost' }, { icon: 'üçÇ', type: 'compost' },
                { icon: 'ü•§', type: 'recycle' }, { icon: 'üì∞', type: 'recycle' }, { icon: 'ü•´', type: 'recycle' }
            ];
            const [currentItem, setCurrentItem] = useState(null);
            const [score, setScore] = useState(0);
            const [count, setCount] = useState(0);
            const [feedback, setFeedback] = useState(null);

            useEffect(() => {
                nextItem();
            }, []);

            const nextItem = () => {
                if (count >= 15) { // Increased count for grinding
                    onComplete(score);
                    return;
                }
                const randomItem = items[Math.floor(Math.random() * items.length)];
                setCurrentItem(randomItem);
                setCount(c => c + 1);
                setFeedback(null);
            };

            const handleSort = (binType) => {
                if (currentItem.type === binType) {
                    setScore(s => s + 5); // Reduced score
                    setFeedback('‚úÖ');
                    setTimeout(nextItem, 300); // Faster transitions
                } else {
                    setFeedback('‚ùå');
                    setTimeout(nextItem, 300);
                }
            };

            if (!currentItem) return <div className="text-center mt-20 font-bold">Loading...</div>;

            return (
                <div className="flex flex-col items-center h-full justify-center">
                    <div className="mb-4 font-bold text-slate-500">{count}/15 Items</div>
                    <div className="text-8xl mb-8 animate-bounce-short h-32 flex items-center justify-center">
                        {feedback || currentItem.icon}
                    </div>
                    
                    <div className="flex gap-4 w-full">
                        <button onClick={() => handleSort('recycle')} className="flex-1 bg-blue-500 text-white py-6 rounded-2xl font-black text-lg btn-game border-blue-700 shadow-xl flex flex-col items-center">
                            <RefreshCw size={32} className="mb-2" /> RECYCLE
                        </button>
                        <button onClick={() => handleSort('compost')} className="flex-1 bg-green-500 text-white py-6 rounded-2xl font-black text-lg btn-game border-green-700 shadow-xl flex flex-col items-center">
                            <Leaf size={32} className="mb-2" /> COMPOST
                        </button>
                    </div>
                </div>
            );
        };

        const PipePatrolGame = ({ onComplete }) => {
            const [leaks, setLeaks] = useState([]);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(15);
            const [gameOver, setGameOver] = useState(false);

            useEffect(() => {
                if (gameOver) return;
                const interval = setInterval(() => {
                    if (Math.random() > 0.2) { // Increased spawn rate
                        const id = Date.now();
                        const x = Math.random() * 80 + 10;
                        const y = Math.random() * 80 + 10;
                        setLeaks(prev => [...prev, { id, x, y }]);
                    }
                }, 600); // Faster leaks
                return () => clearInterval(interval);
            }, [gameOver]);

            useEffect(() => {
                if (timeLeft > 0 && !gameOver) {
                    const timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                    return () => clearInterval(timer);
                } else if (timeLeft === 0) {
                    setGameOver(true);
                }
            }, [timeLeft, gameOver]);

            const fixLeak = (id) => {
                setLeaks(prev => prev.filter(l => l.id !== id));
                setScore(s => s + 5);
            };

            return (
                <div className="h-full flex flex-col relative overflow-hidden bg-slate-100 rounded-3xl border-4 border-slate-300">
                    <div className="absolute top-0 left-0 w-full p-2 flex justify-between z-10 bg-white/80 backdrop-blur-sm">
                        <span className="font-bold">Time: {timeLeft}s</span>
                        <span className="font-black text-blue-600">Score: {score}</span>
                    </div>

                    {!gameOver ? (
                        <div className="relative w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-80">
                            {leaks.map(leak => (
                                <button
                                    key={leak.id}
                                    onClick={() => fixLeak(leak.id)}
                                    className="absolute text-3xl animate-ping"
                                    style={{ left: `${leak.x}%`, top: `${leak.y}%` }}
                                >
                                    üíß
                                </button>
                            ))}
                        </div>
                    ) : (
                        <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-20">
                            <h3 className="text-2xl font-black text-slate-800 mb-2">Pipes Fixed!</h3>
                            <p className="text-slate-600 mb-6">Score: {score}</p>
                            <button onClick={() => onComplete(score)} className="bg-lime-500 text-white px-8 py-3 rounded-xl font-black btn-game">Collect Tokens</button>
                        </div>
                    )}
                </div>
            );
        };

        const TreeLifeGame = ({ onComplete }) => {
            const [stage, setStage] = useState(0); // 0: dig, 1: seed, 2: water, 3: done
            const [clicks, setClicks] = useState(0);
            
            // Harder Thresholds
            const DIG_REQ = 20;
            const PLANT_REQ = 5;
            const WATER_REQ = 30;

            const handleClick = () => {
                setClicks(c => c + 1);
                if (stage === 0 && clicks >= DIG_REQ) {
                    setStage(1); setClicks(0);
                } else if (stage === 1 && clicks >= PLANT_REQ) {
                    setStage(2); setClicks(0);
                } else if (stage === 2 && clicks >= WATER_REQ) {
                    setStage(3); fireConfetti();
                }
            };

            const getProgress = () => {
                if(stage===0) return (clicks/DIG_REQ)*100;
                if(stage===1) return (clicks/PLANT_REQ)*100;
                if(stage===2) return (clicks/WATER_REQ)*100;
                return 100;
            }

            return (
                <div className="h-full flex flex-col items-center justify-center text-center p-4">
                    {stage === 3 ? (
                        <div className="animate-in zoom-in duration-500">
                            <div className="text-9xl mb-4">üå≥</div>
                            <h3 className="text-2xl font-black text-green-700 mb-2">Tree Grown!</h3>
                            <p className="mb-6 text-slate-500">Hard work pays off!</p>
                            <button onClick={() => onComplete(30)} className="bg-lime-500 text-white px-8 py-3 rounded-xl font-black btn-game">Collect 30 Tokens</button>
                        </div>
                    ) : (
                        <>
                            <div className="text-9xl mb-8 transition-all duration-100 transform active:scale-95 select-none animate-breathe">
                                {stage === 0 ? 'üï≥Ô∏è' : stage === 1 ? 'üå∞' : 'üå±'}
                            </div>
                            <h3 className="text-xl font-bold text-slate-700 mb-2">
                                {stage === 0 ? `Tap to Dig! (${clicks}/${DIG_REQ})` : stage === 1 ? `Plant Seed! (${clicks}/${PLANT_REQ})` : `Water Fast! (${clicks}/${WATER_REQ})`}
                            </h3>
                            
                            <div className="w-full max-w-[200px] h-4 bg-slate-200 rounded-full overflow-hidden mb-8">
                                <div 
                                    className="h-full bg-lime-500 transition-all duration-75"
                                    style={{ width: `${getProgress()}%` }}
                                ></div>
                            </div>

                            <button 
                                onMouseDown={handleClick}
                                onTouchStart={(e) => { e.preventDefault(); handleClick(); }} 
                                className="w-full max-w-[200px] py-6 bg-amber-600 text-white rounded-2xl font-black text-xl btn-game border-amber-800 shadow-xl active:scale-95 transition-transform"
                            >
                                TAP!
                            </button>
                        </>
                    )}
                </div>
            );
        };

        const SmogSmashGame = ({ onComplete }) => {
            const [clouds, setClouds] = useState([]);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(15);
            const [gameOver, setGameOver] = useState(false);

            useEffect(() => {
                if (gameOver) return;
                const spawner = setInterval(() => {
                    const id = Date.now();
                    const x = Math.random() * 80 + 5;
                    const isBird = Math.random() > 0.8; 
                    setClouds(prev => [...prev, { id, x, y: 100, isBird }]);
                }, 500); // Faster spawns

                const mover = setInterval(() => {
                    setClouds(prev => prev.map(c => ({...c, y: c.y - 3})).filter(c => c.y > -10)); // Faster movement
                }, 50);

                return () => { clearInterval(spawner); clearInterval(mover); };
            }, [gameOver]);

            useEffect(() => {
                if (timeLeft > 0 && !gameOver) {
                    const timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                    return () => clearInterval(timer);
                } else if (timeLeft === 0) setGameOver(true);
            }, [timeLeft, gameOver]);

            const handleTap = (item) => {
                if (item.isBird) {
                    setScore(s => Math.max(0, s - 20)); // Huge Penalty
                } else {
                    setScore(s => s + 5);
                }
                setClouds(prev => prev.filter(c => c.id !== item.id));
            };

            return (
                <div className="h-full flex flex-col relative overflow-hidden bg-sky-100 rounded-3xl border-4 border-sky-200">
                    <div className="absolute top-0 left-0 w-full p-2 flex justify-between z-10">
                        <span className="font-bold text-slate-600">Time: {timeLeft}s</span>
                        <span className="font-black text-sky-600">Score: {score}</span>
                    </div>

                    {!gameOver ? (
                        <div className="w-full h-full relative">
                            {clouds.map(c => (
                                <div
                                    key={c.id}
                                    onMouseDown={() => handleTap(c)}
                                    onTouchStart={(e) => { e.preventDefault(); handleTap(c); }}
                                    className="absolute text-4xl cursor-pointer select-none transition-transform active:scale-150"
                                    style={{ left: `${c.x}%`, top: `${c.y}%` }}
                                >
                                    {c.isBird ? 'üê¶' : '‚òÅÔ∏è'}
                                </div>
                            ))}
                            <div className="absolute bottom-0 w-full h-10 bg-green-300 rounded-b-xl"></div>
                        </div>
                    ) : (
                        <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-20">
                            <h3 className="text-2xl font-black text-slate-800 mb-2">Clear Skies!</h3>
                            <p className="text-slate-600 mb-6">Score: {score}</p>
                            <button onClick={() => onComplete(score)} className="bg-sky-500 text-white px-8 py-3 rounded-xl font-black btn-game">Collect Tokens</button>
                        </div>
                    )}
                </div>
            );
        };

        const LowBalanceModal = ({ onClose }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white w-full max-w-sm p-6 rounded-[2rem] shadow-2xl border-4 border-red-400 pop-in relative overflow-hidden text-center">
                    <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-500 mx-auto border-2 border-red-200">
                        <XCircle size={32} />
                    </div>
                    <h3 className="text-2xl font-black text-slate-800 mb-2">Low Balance!</h3>
                    <p className="mb-6 text-slate-600">You need more tokens to unlock this theme. Play games in the Arcade to earn more!</p>
                    <button 
                        onClick={onClose}
                        className="w-full bg-red-500 text-white border-red-600 btn-game py-3 rounded-xl font-black text-lg shadow-lg hover:bg-red-400"
                    >
                        OKAY, I'LL PLAY!
                    </button>
                </div>
            </div>
        );

        const ThemeShop = ({ userData, onBuyTheme, onSelectTheme, onClose }) => {
            return (
                <div className="absolute inset-0 bg-white/95 backdrop-blur-md z-50 flex flex-col animate-in slide-in-from-bottom duration-300">
                    <div className="p-6 flex justify-between items-center border-b-2 border-slate-100">
                        <h2 className="text-2xl font-black text-slate-800">Theme Shop</h2>
                        <button onClick={onClose} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200">
                            <ArrowRight size={20} className="rotate-90" />
                        </button>
                    </div>
                    
                    <div className="p-6 grid grid-cols-2 gap-4 overflow-y-auto no-scrollbar pb-24">
                        {userData.themes.map((theme) => (
                            <button 
                                key={theme.id}
                                onClick={() => theme.locked ? onBuyTheme(theme) : onSelectTheme(theme.id)}
                                className={`aspect-square rounded-3xl p-4 flex flex-col items-center justify-center gap-3 relative overflow-hidden transition-all duration-300
                                    ${theme.locked ? 'bg-slate-100 border-4 border-slate-200 opacity-90' : 
                                      userData.activeTheme === theme.id ? 'ring-4 ring-lime-500 ring-offset-2 scale-105' : 'hover:scale-105'}
                                    ${!theme.locked && theme.color}
                                `}
                            >
                                <div className={`w-12 h-12 rounded-full ${theme.color} border-2 border-black/10 shadow-inner flex items-center justify-center text-2xl transition-transform duration-500 hover:rotate-12`}>
                                    üé®
                                </div>
                                <span className="font-bold text-slate-800">{theme.name}</span>
                                
                                {theme.locked ? (
                                    <div className="bg-slate-800 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                        <Gamepad size={12} /> {theme.price}
                                    </div>
                                ) : (
                                    userData.activeTheme === theme.id && <div className="absolute top-2 right-2 bg-lime-500 text-white p-1 rounded-full"><Check size={12} /></div>
                                )}
                            </button>
                        ))}
                    </div>
                    
                    <div className="p-4 border-t border-slate-100 bg-white absolute bottom-0 w-full">
                        <div className="flex justify-between items-center bg-purple-50 p-4 rounded-xl border-2 border-purple-100">
                            <span className="font-bold text-purple-900">Your Balance:</span>
                            <div className="flex items-center gap-2 font-black text-purple-700 text-xl">
                                <Gamepad size={24} /> {userData.gamePoints}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD & HUB ---

        const Dashboard = ({ user, userData, onStartMission, onClaimReward }) => {
            const today = new Date().toDateString();
            const rewardAvailable = userData.lastRewardDate !== today;
            const missionDone = userData.lastMissionDate === today;
            const [timeLeft, setTimeLeft] = useState('');
            
            // Generate quote based on date to keep it consistent for the day
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const dailyQuote = ecoQuotes[dayOfYear % ecoQuotes.length];

            useEffect(() => {
                if (rewardAvailable) setTimeout(() => fireConfetti(), 500);
                const timer = setInterval(() => {
                    const now = new Date();
                    const tomorrow = new Date(now);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(0, 0, 0, 0);
                    const diff = tomorrow - now;
                    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
                    const minutes = Math.floor((diff / 1000 / 60) % 60);
                    setTimeLeft(`${hours}h ${minutes}m`);
                }, 60000);
                return () => clearInterval(timer);
            }, [rewardAvailable]);

            return (
                <div className="h-full flex flex-col p-6 pb-24 w-full fade-in overflow-y-auto no-scrollbar">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-2 bg-white/60 p-2 pr-4 rounded-full border-2 border-white backdrop-blur-sm shadow-sm transition-all hover:scale-105">
                            <div className={`w-10 h-10 rounded-full overflow-hidden border-2 border-white ${user.avatar.color} animate-breathe`}>
                                <img src={`https://api.dicebear.com/9.x/adventurer/svg?seed=${user.avatar.seed}`} alt="Avatar" />
                            </div>
                            <span className="font-bold text-slate-700">{user.name}</span>
                        </div>
                        <div className="flex gap-2">
                            <div className="flex items-center gap-1 bg-yellow-400 text-yellow-900 px-3 py-1.5 rounded-full font-black border-b-4 border-yellow-500 shadow-sm text-xs">
                                <Coins size={14} /> {userData.coins}
                            </div>
                            <div className="flex items-center gap-1 bg-purple-400 text-purple-900 px-3 py-1.5 rounded-full font-black border-b-4 border-purple-500 shadow-sm text-xs">
                                <Gamepad size={14} /> {userData.gamePoints}
                            </div>
                        </div>
                    </div>

                    {/* Daily Quote */}
                    <div className="mb-6 p-4 bg-white/40 rounded-2xl backdrop-blur-sm border border-white/50 text-center italic text-slate-600 text-sm font-medium">
                        "{dailyQuote}"
                    </div>

                    {/* Main Stats */}
                    <div className="bg-white rounded-[2rem] p-6 shadow-xl border-b-8 border-slate-200 mb-6 relative overflow-hidden transition-transform hover:scale-[1.02] duration-300">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><Trophy size={80} /></div>
                        <div className="flex justify-between items-end">
                            <div>
                                <p className="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1">Current Streak</p>
                                <div className="text-4xl font-black text-slate-800 flex items-center gap-2">{userData.streak} <span className="text-2xl">üî•</span></div>
                            </div>
                            <div className="text-right">
                                <p className="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1">Total XP</p>
                                <div className="text-2xl font-bold text-lime-600">{userData.xp} XP</div>
                            </div>
                        </div>
                        <div className="mt-4 w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                            <div className="h-full bg-lime-500 w-[70%] rounded-full transition-all duration-1000"></div>
                        </div>
                    </div>

                    {/* Reward */}
                    {rewardAvailable && (
                        <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-[2rem] p-6 text-white shadow-lg border-b-8 border-indigo-700 mb-6 relative overflow-hidden animate-float">
                            <div className="relative z-10">
                                <h3 className="text-2xl font-black mb-1">Daily Reward!</h3>
                                <button onClick={onClaimReward} className="bg-yellow-400 text-yellow-900 w-full py-3 mt-4 rounded-xl font-black btn-game border-yellow-500 shadow-lg flex items-center justify-center gap-2">
                                    <Gift size={20} /> Claim +50 Coins
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Mission */}
                    <div className="rounded-[2rem] p-6 shadow-lg border-b-8 transition-all bg-white border-lime-200 mb-6">
                        <div className="flex items-center gap-4 mb-4">
                            <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-sm border-b-4 ${missionDone ? 'bg-slate-300 border-slate-400 grayscale' : 'bg-lime-100 border-lime-200 text-lime-600'}`}>üåç</div>
                            <div>
                                <h4 className="font-bold text-lg text-slate-800">Eco Check-in</h4>
                                <p className="text-xs font-bold text-slate-400 uppercase">{missionDone ? 'Completed' : '+100 XP available'}</p>
                            </div>
                        </div>
                        {missionDone ? (
                            <div className="bg-slate-300/50 rounded-xl p-3 flex items-center justify-center gap-2 font-bold text-slate-500"><Lock size={18} /> Next in {timeLeft}</div>
                        ) : (
                            <button onClick={onStartMission} className="w-full bg-lime-500 text-white py-4 rounded-xl font-black text-xl btn-game border-lime-600 shadow-xl flex items-center justify-center gap-2">START MISSION <ArrowRight size={24} /></button>
                        )}
                    </div>
                </div>
            );
        };

        const GamesHub = ({ onPlayGame, gamePoints, onOpenShop }) => {
            const games = [
                { id: 'lights', name: 'Energy Saver', color: 'bg-yellow-400', border: 'border-yellow-600', icon: 'üí°', desc: 'Turn off lights!' },
                { id: 'trash', name: 'Trash Master', color: 'bg-green-400', border: 'border-green-600', icon: '‚ôªÔ∏è', desc: 'Sort waste fast.' },
                { id: 'pipes', name: 'Pipe Patrol', color: 'bg-blue-400', border: 'border-blue-600', icon: 'üö∞', desc: 'Fix water leaks.' },
                { id: 'tree', name: 'Tree Life', color: 'bg-amber-500', border: 'border-amber-700', icon: 'üå≥', desc: 'Grow a tree.' },
                { id: 'smog', name: 'Smog Smash', color: 'bg-gray-400', border: 'border-gray-600', icon: '‚òÅÔ∏è', desc: 'Clear pollution.' },
            ];

            return (
                <div className="h-full flex flex-col p-6 pb-24 w-full fade-in overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-black text-slate-800">Arcade</h2>
                        <button 
                            onClick={onOpenShop}
                            className="flex items-center gap-2 bg-purple-100 text-purple-900 px-4 py-2 rounded-full font-black border-2 border-purple-200 hover:bg-purple-200 transition-all hover:scale-105 shadow-sm"
                        >
                            <ShoppingCart size={20} /> Shop
                        </button>
                    </div>
                    
                    <div className="bg-purple-500 text-white p-4 rounded-2xl mb-6 flex justify-between items-center shadow-lg border-b-4 border-purple-700 animate-float">
                        <span className="font-bold">My Tokens</span>
                        <div className="flex items-center gap-2 text-2xl font-black">
                            <Gamepad size={24} /> {gamePoints}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-4">
                        {games.map(game => (
                            <button 
                                key={game.id}
                                onClick={() => onPlayGame(game.id)}
                                className={`w-full p-4 rounded-3xl ${game.color} border-b-8 ${game.border} shadow-lg btn-game flex items-center gap-4 text-white text-left relative overflow-hidden transition-transform hover:scale-[1.02]`}
                            >
                                <div className="text-4xl bg-white/20 p-3 rounded-2xl backdrop-blur-sm">{game.icon}</div>
                                <div>
                                    <h3 className="font-black text-xl">{game.name}</h3>
                                    <p className="text-sm font-bold opacity-90">{game.desc}</p>
                                </div>
                                <div className="absolute right-4 opacity-50"><ArrowRight size={32} /></div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const BottomNav = ({ currentView, onChangeView }) => (
            <div className="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white rounded-full shadow-2xl border-4 border-slate-100 p-2 flex gap-2 z-50">
                <button 
                    onClick={() => onChangeView('dashboard')}
                    className={`p-4 rounded-full transition-all duration-300 ${currentView === 'dashboard' ? 'bg-lime-500 text-white shadow-lg scale-110' : 'text-slate-400 hover:bg-slate-100'}`}
                >
                    <LayoutDashboard size={24} strokeWidth={3} />
                </button>
                <button 
                    onClick={() => onChangeView('games')}
                    className={`p-4 rounded-full transition-all duration-300 ${currentView === 'games' ? 'bg-purple-500 text-white shadow-lg scale-110' : 'text-slate-400 hover:bg-slate-100'}`}
                >
                    <Gamepad size={24} strokeWidth={3} />
                </button>
            </div>
        );

        // --- Main App ---

        const App = () => {
            const [view, setView] = useState('welcome'); 
            const [activeTab, setActiveTab] = useState('dashboard'); 
            const [activeGame, setActiveGame] = useState(null); 
            const [showShop, setShowShop] = useState(false);
            const [showLowBalance, setShowLowBalance] = useState(false);
            const [user, setUser] = useState(null);
            
            const [userData, setUserData] = useState({
                coins: 0,
                gamePoints: 0, 
                xp: 0,
                streak: 0,
                lastRewardDate: null,
                lastMissionDate: null,
                activeTheme: 'forest',
                themes: themes 
            });

            // Quiz State
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [quizScore, setQuizScore] = useState(0);
            const [quizRedFlags, setQuizRedFlags] = useState([]);

            useEffect(() => {
                const storedUser = localStorage.getItem('eco_user');
                const storedData = localStorage.getItem('eco_data');
                if (storedUser) setUser(JSON.parse(storedUser));
                if (storedData) {
                    const parsed = JSON.parse(storedData);
                    const mergedThemes = themes.map(t => {
                        const saved = parsed.themes?.find(st => st.id === t.id);
                        return saved ? saved : t;
                    });
                    setUserData({ ...parsed, themes: mergedThemes });
                }
            }, []);

            useEffect(() => {
                if (user) localStorage.setItem('eco_user', JSON.stringify(user));
                if (userData) localStorage.setItem('eco_data', JSON.stringify(userData));
                
                // Apply Theme
                document.body.className = `text-slate-800 antialiased h-screen overflow-hidden selection:bg-lime-200 transition-colors duration-500 theme-${userData.activeTheme}`;
            }, [user, userData]);

            const handleLogin = (name, avatar) => {
                setUser({ name, avatar });
                setView('main');
            };

            const claimDailyReward = () => {
                const today = new Date().toDateString();
                setUserData(prev => ({ ...prev, coins: prev.coins + 50, lastRewardDate: today }));
                fireConfetti();
            };

            const startMission = () => {
                setCurrentQIndex(0); setQuizScore(0); setQuizRedFlags([]);
                setView('quiz');
            };

            const handleAnswer = (qId, option) => {
                setQuizScore(prev => prev + option.score);
                if (option.type === 'red') {
                    const q = questions.find(qu => qu.id === qId);
                    setQuizRedFlags(prev => [...prev, { id: qId, title: q.title, issue: option.label }]);
                }
                if (currentQIndex < questions.length - 1) {
                    setCurrentQIndex(prev => prev + 1);
                } else {
                    const today = new Date().toDateString();
                    setUserData(prev => ({ ...prev, xp: prev.xp + 100, streak: prev.streak + 1, lastMissionDate: today, coins: prev.coins + 20 }));
                    setView('result');
                    fireConfetti();
                }
            };

            // Game Logic
            const handlePlayGame = (gameId) => {
                setActiveGame(gameId);
                setView('playing_game');
            };

            const handleGameComplete = (score) => {
                setUserData(prev => ({ ...prev, gamePoints: prev.gamePoints + score }));
                setActiveGame(null);
                setView('main');
                fireConfetti();
            };

            // Shop Logic
            const handleBuyTheme = (theme) => {
                if (userData.gamePoints >= theme.price) {
                    setUserData(prev => ({
                        ...prev,
                        gamePoints: prev.gamePoints - theme.price,
                        themes: prev.themes.map(t => t.id === theme.id ? { ...t, locked: false } : t),
                        activeTheme: theme.id
                    }));
                    fireConfetti();
                } else {
                    setShowLowBalance(true);
                }
            };

            const handleSelectTheme = (id) => {
                setUserData(prev => ({ ...prev, activeTheme: id }));
            };

            // Main View Rendering (Tabs)
            const renderMainContent = () => {
                if (activeTab === 'dashboard') {
                    return <Dashboard user={user} userData={userData} onStartMission={startMission} onClaimReward={claimDailyReward} />;
                } else {
                    return <GamesHub onPlayGame={handlePlayGame} gamePoints={userData.gamePoints} onOpenShop={() => setShowShop(true)} />;
                }
            };

            return (
                <div className="w-full h-[100dvh] bg-slate-50 overflow-hidden relative flex flex-col transition-all duration-300">
                    <div className="absolute top-0 left-0 w-64 h-64 bg-lime-200 rounded-full blur-3xl opacity-40 pointer-events-none -translate-x-1/2 -translate-y-1/2 transition-colors duration-500" style={{backgroundColor: 'var(--pattern-color)'}}></div>
                    <div className="absolute bottom-0 right-0 w-96 h-96 bg-yellow-200 rounded-full blur-3xl opacity-40 pointer-events-none translate-x-1/4 translate-y-1/4"></div>

                    <div className="w-full h-full max-w-2xl mx-auto flex flex-col relative z-10">
                        {view === 'welcome' && (
                            <div className="flex flex-col items-center justify-center h-full text-center p-8 fade-in">
                                <div className="w-24 h-24 bg-white rounded-3xl shadow-xl flex items-center justify-center mb-6 animate-float border-4 border-lime-200"><Leaf size={48} className="text-lime-500" /></div>
                                <h1 className="text-4xl font-black text-lime-800 mb-2">EcoTrace</h1>
                                <p className="text-lime-700 font-bold text-lg mb-8 max-w-xs">Play your part in saving the planet, one day at a time.</p>
                                <button onClick={() => user ? setView('main') : setView('login')} className="bg-lime-500 text-white w-full py-4 rounded-2xl font-black text-xl btn-game border-lime-600 shadow-xl">{user ? 'CONTINUE' : 'PLAY NOW'}</button>
                            </div>
                        )}

                        {view === 'login' && <LoginScreen onLogin={handleLogin} />}

                        {view === 'main' && (
                            <>
                                {renderMainContent()}
                                <BottomNav currentView={activeTab} onChangeView={setActiveTab} />
                                {showShop && (
                                    <ThemeShop 
                                        userData={userData} 
                                        onBuyTheme={handleBuyTheme} 
                                        onSelectTheme={handleSelectTheme} 
                                        onClose={() => setShowShop(false)} 
                                    />
                                )}
                                {showLowBalance && (
                                    <LowBalanceModal onClose={() => setShowLowBalance(false)} />
                                )}
                            </>
                        )}

                        {view === 'quiz' && <QuizScreen question={questions[currentQIndex]} onAnswer={handleAnswer} total={questions.length} current={currentQIndex} />}

                        {view === 'playing_game' && (
                            <div className="h-full p-6 pt-10 fade-in flex flex-col">
                                <button onClick={() => setView('main')} className="mb-4 text-slate-500 font-bold flex items-center gap-2 hover:bg-slate-200 p-2 rounded-lg w-fit transition-colors"><ArrowRight className="rotate-180" size={20}/> Back to Arcade</button>
                                <div className="flex-1 bg-white rounded-3xl shadow-2xl p-4 border-4 border-slate-200">
                                    {activeGame === 'lights' && <EnergySaverGame onComplete={handleGameComplete} />}
                                    {activeGame === 'trash' && <TrashMasterGame onComplete={handleGameComplete} />}
                                    {activeGame === 'pipes' && <PipePatrolGame onComplete={handleGameComplete} />}
                                    {activeGame === 'tree' && <TreeLifeGame onComplete={handleGameComplete} />}
                                    {activeGame === 'smog' && <SmogSmashGame onComplete={handleGameComplete} />}
                                </div>
                            </div>
                        )}

                        {view === 'result' && (
                            <div className="flex flex-col h-full p-6 pt-10 text-center fade-in overflow-y-auto no-scrollbar">
                                <div className="mb-6"><div className="w-24 h-24 bg-yellow-400 rounded-full mx-auto flex items-center justify-center text-white border-4 border-yellow-500 shadow-xl animate-bounce-short"><Trophy size={48} /></div></div>
                                <h2 className="text-3xl font-black text-slate-800 mb-2">Mission Complete!</h2>
                                <p className="text-slate-500 font-bold mb-8">You earned +100 XP and Coins.</p>
                                <div className="bg-white rounded-3xl p-6 shadow-xl border-b-8 border-slate-100 mb-6">
                                    <p className="text-xs uppercase tracking-widest font-black text-slate-400 mb-2">Total Score</p>
                                    <p className="text-6xl font-black text-lime-600">{quizScore}</p>
                                </div>
                                {quizRedFlags.length > 0 ? (
                                    <div className="text-left bg-red-50 rounded-3xl p-6 border-2 border-red-100 mb-6">
                                        <h3 className="font-black text-red-500 mb-4 flex items-center gap-2"><AlertCircle size={20}/> Improvements</h3>
                                        {quizRedFlags.map((flag, idx) => (<div key={idx} className="mb-3 last:mb-0"><p className="font-bold text-slate-700 text-sm">{flag.title}</p><p className="text-red-500 text-xs font-bold">Try to avoid: {flag.issue}</p></div>))}
                                    </div>
                                ) : (
                                    <div className="bg-lime-100 p-4 rounded-2xl mb-6 text-lime-700 font-bold border-2 border-lime-200">Perfect Run! No energy wasted. üåø</div>
                                )}
                                <button onClick={() => setView('main')} className="mt-auto w-full bg-slate-800 text-white py-4 rounded-xl font-black text-lg btn-game border-slate-900 shadow-xl">BACK TO HUB</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
